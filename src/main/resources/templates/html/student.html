<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>主页</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">

</head>

<link rel="stylesheet" th:href="@{/static/layui/2.5.4/css/layui.css}" media="all" />
<link rel="stylesheet" th:href="@{/static/layui/2.5.4/css/layui.mobile.css}" media="all">
<link rel="stylesheet" th:href="@{/static/layui/2.5.4/css/modules/layer/default/layer.css}" media="all">
<link rel="stylesheet" th:href="@{/static/layui/2.5.4/css/modules/laydate/default/laydate.css}" media="all">

<body>
<div id="header">
    <div class="layui-btn-group demoTable">
        <button class="layui-btn" data-type="add">添加</button>
    </div>
    <div class="demoTable">
        书名搜索：
        <div class="layui-inline">
            <input class="layui-input" name="bookName" id="demoReload" >
        </div>
        发行数量搜索：
        <div class="layui-inline">
            <input class="layui-input" name="start" id="start" >
            到
            <input class="layui-input" name="end" id="end">
        </div>
        <br>
        时间搜索：
        <div class="layui-inline">
            <input class="layui-input" name="starttime" id="starttime" >
            到
            <input class="layui-input" name="endtime" id="endtime" >
        </div>
        <button class="layui-btn" data-type="reload">搜索</button>
    </div>
    <table class="layui-hide" id="text" lay-filter="test"></table>

    <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看</a>
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    </script>

    <div class="site-text" style="margin: 5%; display: none" id="box1"  target="123">
        <form class="layui-form layui-form-pane" onsubmit="return false" id="booktype">
            <div class="layui-form-item">
                <label class="layui-form-label">产品编号</label>
                <div class="layui-input-block">
                    <input type="text" class="layui-input"  id="productNum"  name="productNum"><br>
                </div>
                <br>
                <label class="layui-form-label"> 产品名称</label>
                <div class="layui-input-block">
                    <input type="text" class="layui-input"  id="productName"  name="productName"><br>
                </div>

                <label class="layui-form-label"> 出发城市</label>
                <div class="layui-input-block">
                    <input type="text" class="layui-input"  id="cityName"  name="cityName"><br>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">封面</label>
                    <input type="hidden" id="hidden" name="upload">
                    <div class="layui-upload">
                        <button type="button" class="layui-btn " id="test2">修改封面</button>
                        <div class="layui-upload-list">
                            <img class="layui-upload-img" id="demo3">
                        </div>
                    </div>
                </div>



                <label class="layui-form-label"> 产品价格</label>
                <div class="layui-input-block">
                    <input type="text" class="layui-input"  id="productPrice"  name="productPrice"><br>
                </div>

                <label class="layui-form-label"> 产品描述</label>
                <div class="layui-input-block">
                    <input type="text" class="layui-input"  id="productDesc"  name="productDesc"><br>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">是否发布</label>
                    <div class="layui-input-block">
                        <input type="checkbox" checked="" id="productsStatus"  name="productsStatus" lay-skin="switch" lay-filter="switchTest" lay-text="是|否">
                    </div>
                </div>


            </div>
        </form>
    </div>

</div>

</body>

<script th:src="@{/static/layui/2.5.4/lay/modules/jquery.js}"></script>
<script type="text/javascript" th:src="@{/static/layui/2.5.4/layui.js}"></script>
<script th:src="@{/static/layui/2.5.4/lay/modules/laydate.js}" type="text/javascript" charset="utf-8"></script>

<script>
    layui.use(['table','laypage','layer','util','form','upload'], function() {

        var table = layui.table;//表格
        var laypage = layui.laypage;
        var layer = layui.layer;
        var util = layui.util;
        var upload = layui.upload;


        var uploadInst = upload.render({
            elem: '#test2'
            , url: ''
            // , auto: false //选择文件后不自动上传
            // , drag: true,
            // bindAction:'.layui-layer-btn0'
            , field: 'upload'

            //上传前的回调
            , choose: function (obj) {
                //预读本地文件示例，不支持ie8
                obj.preview(function (index, file, result) {
                    $('#demo3').attr('src', result); //图片链接（base64）
                });
            }
            , done: function (res,index,upload) {
                if (res.code > 0){
                    return layer.msg("上传失败")
                }else{
                    $('#hidden').val(res.data)
                }

            }
            , error: function (res, index) {

                alert("修改图片失败");
                //演示失败状态，并实现重传
                layer.closeAll('loading');

            }
        });
        table.render({
            elem: '#text'
            , url: ''
            ,page:true
            ,limit:5
            ,method:"post"
            ,dataType: "json"
            ,contentType:"application/json;charset=UTF-8"
            ,parseData: function(res){
                return {
                    "code": 0,
                    "msg":"",
                    "count":res.data.total,
                    "data":res.data.list
                };
            }
            , cols: [
                [ //表头
                {type: 'checkbox', fixed: 'left'}
                , {field: 'id', title: 'ID', width: 80 }
                , {field: 'productNum', title: '产品编号', width: 120}
                , {field:  "productName", title: '产品名称', width: 120, sort: true, totalRow: true}
                , {field:  "cityName", title: '出发城市', width: 120, sort: true, totalRow: true}
                , {field:  "departureTime", title: '出发时间', width: 120, sort: true, totalRow: true ,templet:function (d) {
                        return util.toDateString(d.departuretime, "yyyy-MM-dd HH:mm:ss");
                    }}
                , {field:  "productPrice", title: '产品价格(元)', width: 120, sort: true, totalRow: true}
                , {field:  "upload", title: '头像', width: 120, sort: true, totalRow: true ,templet:function (d) {
                        return '<img src='${pageContext.request.contextPath}+d.upload+' height="20"/>';
                    }}
                , {field:  "productsStatus", title: '状态', width: 120, sort: true, templet:'#productsStatusS'}
                , {field:  "productDesc", title: '产品描述', width: 120, sort: true, totalRow: true}
                , {fixed: 'right', width: 200, align: 'center', toolbar: '#barDemo'}
            ]
            ]

            ,id: 'text'

        });
        table.on('tool(test)', function(obj){ //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
            var tr = obj.tr; //获得当前行 tr 的 DOM 对象（如果有的话）
            if(layEvent === 'detail'){ //查看
                //do somehing
            } else if(layEvent === 'del'){ //删除
                layer.confirm('真的删除行么', function(index){
                    obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                    layer.close(index);
                    //向服务端发送删除指令
                    $.post("",{id:data.id},function (s) {
                        alert(s)
                    })
                    table.reload('text',{//重载表格
                        page:{
                            curr:1
                        }
                    })

                })
            } else if(layEvent === 'edit'){ //编辑
                layer.open({
                    type: 1 //Page层类型
                    ,skin: 'layui-layer-molv'
                    ,area: ['580px', '570px']
                    ,title: ['编辑信息','font-size:18px']
                    ,btn: ['确定', '取消']
                    ,shadeClose: true
                    ,shade: 0 //遮罩透明度
                    ,maxmin: true //允许全屏最小化
                    ,content:$('#box1')  //弹窗id
                    ,success:function(layero,index){
                        $('#productNum').val(data.productNum);
                        $('#productName').val(data.productName);
                        $('#cityName').val(data.cityName);
                        $('#demo3').attr('src', data.upload);
                        $('#productPrice').val(data.productPrice);
                        $('#productDesc').val(data.productDesc);
                        $('#productsStatus').val(data.productsStatus);
                    },
                    yes:function(index,layero){
                        /*  $.ajaxSettings.async = false; */
                        $.post('' ,{
                            productNum:$("#productNum").val(),
                            productName:$("#productName").val(),
                            cityName:$("#cityName").val(),
                            upload:$("#hidden").val(),
                            productPrice:$("#productPrice").val(),
                            productDesc:$("#productDesc").val(),
                            productsStatus:$("#productsStatus").val() == "是" ? "1" : "0",
                            id:data.id
                        },function(data){
                            //根据后台返回的参数，来进行判断
                            if(data>0){
                                layer.alert('编辑成功',{icon:1,title:'提示'},function(i){
                                    layer.close(i);
                                    layer.close(index);//关闭弹出层
                                    $("#booktype")[0].reset()//重置form
                                })
                                table.reload('text',{//重载表格
                                    page:{
                                        curr:1
                                    }
                                })
                            }
                        });
                    }


                });

            } else if(layEvent === 'LAYTABLE_TIPS'){
                layer.alert('Hi，头部工具栏扩展的右侧图标。');
            }
        });

        //分页
        laypage.render({
            elem: 'demo3'
            ,first: '首页'
            ,last: '尾页'
            ,prev: '<em>←</em>'
            ,next: '<em>→</em>'
        });


        var $ = layui.$, active = {
            add: function(){ //获取选中数据
                layer.open({
                    type: 2,
                    content: '',
                    area: ['80%', '80%']//这里content是一个URL，如果你不想让iframe出现滚动条，你还可以content: ['http://sentsin.com', 'no']
                });
            }, reload: function(){

                var demoReload = $('#demoReload');
                var start = $('#start');
                var end = $('#end');
                var starttime = $('#starttime');
                var endtime = $('#endtime');
                //执行重载
                table.reload('text', {
                    page: {
                        curr: 1 //重新从第 1 页开始
                    }
                    ,where: {
                        'bookName':demoReload.val(),
                        'start':start.val(),
                        'end':end.val(),
                        'starttime':starttime.val(),
                        'endtime':endtime.val()

                    }
                });
            }
        };
        $('.demoTable .layui-btn').on('click', function(){
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
    })
</script>

<script type="text/html" id="productsStatusS">
    {{# if(d.productsStatus == 1){}}
    <span>{{ '已发布' }}</span>
    {{# } else { }}
    <span>{{ '未发布' }}</span> {{#  }}}
</script>

</html>
